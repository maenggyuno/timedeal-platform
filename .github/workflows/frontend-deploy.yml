# .github/workflows/frontend-backend-deploy.disabled.yml (Frontend)
#name: Frontend CI/CD
#
#on:
#    push:
#        branches: [ "main" ]
#        paths:
#            - 'frontend/**'
#            - 'docker-compose.yml'
#
#jobs:
#    build-and-deploy:
#        runs-on: ubuntu-latest
#        steps:
#            - name: Checkout
#              uses: actions/checkout@v3
#
#            - name: Login to Docker Hub
#              uses: docker/login-action@v2
#              with:
#                  username: ${{ secrets.DOCKERHUB_USERNAME }}
#                  password: ${{ secrets.DOCKERHUB_TOKEN }}
#
#            # ğŸ‘‡ [ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„] ë¹Œë“œ ì „ì— .env íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤!
#            - name: Create .env file for Frontend
#              run: |
#                  # frontend í´ë”ë¡œ ì´ë™ (ì¤‘ìš”!)
#                  cd frontend
#
#                  # .env íŒŒì¼ ìƒì„± ì‹œì‘
#                  touch .env
#
#                  # 1. ë°±ì—”ë“œ API ì£¼ì†Œ (ìš´ì˜ ì„œë²„ IP nginx ë•Œë©” ê·¸ëƒ¥ 3.~ ê·¸ê²ƒë§Œ ì ì–´ë¼)
#                  echo "REACT_APP_API_URL=${{ vars.REACT_APP_API_URL }}" >> .env
#                  echo "REACT_APP_BACKEND_URL=${{ vars.REACT_APP_BACKEND_URL }}" >> .env
#
#                  # 2. í†µê³„ì²­(SGIS) ì£¼ì†Œ - ë°±ì—”ë“œë¡œ ì˜®ê²¨ì„œ ì´ì œ í”„ë¡ íŠ¸ì—ì„œ ëª°ë¼ë„ ë¨ ì£¼ì„ì²˜ë¦¬í•¨
#                  # echo "REACT_APP_API_BASE_URL=https://sgisapi.mods.go.kr" >> .env
#
#                  # 3. ê°ì¢… ì‹œí¬ë¦¿ í‚¤ ì£¼ì… (GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
#                  echo "REACT_APP_NAVER_MAPS_CLIENT_ID=${{ secrets.REACT_APP_NAVER_MAPS_CLIENT_ID }}" >> .env
#                  echo "REACT_APP_TOSS_PAYMENTS_CLIENT_KEY=${{ secrets.REACT_APP_TOSS_PAYMENTS_CLIENT_KEY }}" >> .env
#                  echo "REACT_APP_SGIS_CLIENT_KEY=${{ secrets.REACT_APP_SGIS_CLIENT_KEY }}" >> .env
#                  #ì‹œê°„ ìƒ ë°°í¬ í›„ ì‹œí¬ë¦¿ í‚¤ ë°±ì—”ë“œë¡œ í”„ë¡ì‹œ ê¸°ëŠ¥ ì´ì „ ì˜ˆì •
#                  echo "REACT_APP_SGIS_SECRET=${{ secrets.REACT_APP_SGIS_SECRET }}" >> .env
#
#                  # íŒŒì¼ ì˜ ë§Œë“¤ì–´ì¡Œë‚˜ í™•ì¸ (ë‚´ìš©ì€ ì•ˆ ë³´ì—¬ì¤Œ)
#                  echo ".env created successfully!"
#
#            - name: Build and push Docker image
#              uses: docker/build-push-action@v4
#              with:
#                  context: ./frontend
#                  file: ./frontend/Dockerfile
#                  push: true
#                  tags: ${{ secrets.DOCKER_IMAGE_FRONTEND }}
#
#            # [ìë™í™”] í´ë”ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë‚˜ë‹ˆê¹Œ, ë¯¸ë¦¬ ìƒì„±í•´ì¤ë‹ˆë‹¤!
#            - name: Create directory on EC2
#              uses: appleboy/ssh-action@master
#              with:
#                  host: ${{ secrets.EC2_HOST }}
#                  username: ${{ secrets.EC2_USERNAME }}
#                  key: ${{ secrets.EC2_SSH_KEY }}
#                  port: 22
#                  script: |
#                      # -p ì˜µì…˜: í´ë”ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œí•˜ê³ , ì—†ìœ¼ë©´ ë§Œë“­ë‹ˆë‹¤. (ì—ëŸ¬ ì•ˆ ë‚¨!)
#                      mkdir -p /home/ubuntu/timedeal-platform
#
#            # ğŸ‘‡ [ìƒˆë¡œ ì¶”ê°€] docker-compose.yml íŒŒì¼ì„ EC2ë¡œ ë³µì‚¬ (ì „ì†¡)
#            - name: Copy Docker Compose file to EC2
#              uses: appleboy/scp-action@master
#              with:
#                  host: ${{ secrets.EC2_HOST }}
#                  username: ${{ secrets.EC2_USERNAME }}
#                  key: ${{ secrets.EC2_SSH_KEY }}
#                  port: 22
#                  # ë‚´ ê¹ƒí—ˆë¸Œ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìˆëŠ” docker-compose.yml íŒŒì¼ì„
#                  source: "docker-compose.yml"
#                  # EC2ì˜ ì´ í´ë”ë¡œ ë®ì–´ì”Œì›Œë¼!
#                  target: "/home/ubuntu/timedeal-platform"
#
#            - name: Deploy to EC2
#              uses: appleboy/ssh-action@master
#              with:
#                  host: ${{ secrets.EC2_HOST }}
#                  username: ${{ secrets.EC2_USERNAME }}
#                  key: ${{ secrets.EC2_SSH_KEY }}
#                  port: 22
#                  script: |
#                      cd /home/ubuntu/timedeal-platform
#
#                      # 1. ìµœì‹  í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ë¥¼ pull
#                      docker-compose pull frontend
#
#                      # 2. í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆë§Œ ì¬ì‹œì‘
#                      docker-compose up -d --no-deps frontend
#
#                      # 3. ì´ë¯¸ì§€ ì°Œêº¼ê¸° ì •ë¦¬
#                      docker image prune -f

name: Frontend Deploy to S3

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend # ğŸ‘ˆ ì´ë¯¸ ì—¬ê¸°ì„œ frontend í´ë”ë¡œ ë“¤ì–´ê°„ ìƒíƒœì…ë‹ˆë‹¤!

    steps:
      - name: ì²´í¬ì•„ì›ƒ (ì½”ë“œ ê°€ì ¸ì˜¤ê¸°)
        uses: actions/checkout@v3

      - name: Node.js ì„¸íŒ…
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # ğŸ‘‡ [ìˆ˜ì •ë¨] ë“¤ì—¬ì“°ê¸° ë§ì¶¤ & 'cd frontend' ì œê±°
      - name: í™˜ê²½ë³€ìˆ˜ íŒŒì¼(.env) ìƒì„±
        run: |
          # ì´ë¯¸ working-directoryê°€ ./frontendë¼ì„œ 'cd frontend'ë¥¼ ë˜ í•˜ë©´ ì—ëŸ¬ë‚©ë‹ˆë‹¤. ë°”ë¡œ ë§Œë“œì„¸ìš”.
          touch .env

          # 1. ë°±ì—”ë“œ ì—°ê²° ì •ë³´ (GitHub Variables)
          echo "REACT_APP_API_URL=${{ vars.REACT_APP_API_URL }}" >> .env
          echo "REACT_APP_BACKEND_URL=${{ vars.REACT_APP_BACKEND_URL }}" >> .env

          # 2. ì‹œí¬ë¦¿ í‚¤ ì£¼ì… (GitHub Secrets)
          echo "REACT_APP_NAVER_MAPS_CLIENT_ID=${{ secrets.REACT_APP_NAVER_MAPS_CLIENT_ID }}" >> .env
          echo "REACT_APP_TOSS_PAYMENTS_CLIENT_KEY=${{ secrets.REACT_APP_TOSS_PAYMENTS_CLIENT_KEY }}" >> .env
          echo "REACT_APP_SGIS_CLIENT_KEY=${{ secrets.REACT_APP_SGIS_CLIENT_KEY }}" >> .env
          echo "REACT_APP_SGIS_SECRET=${{ secrets.REACT_APP_SGIS_SECRET }}" >> .env

          echo ".env created successfully!"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ ë° ë¹Œë“œ
        run: |
          npm install
          CI=false npm run build
        # âš ï¸ ìœ„ì—ì„œ .env íŒŒì¼ì„ ë§Œë“¤ì—ˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œ env: ì„¹ì…˜ì€ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. (ì¤‘ë³µ ì œê±°)

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ap-northeast-2

      - name: S3ì— íŒŒì¼ ì—…ë¡œë“œ (ë™ê¸°í™”)
        run: |
          aws s3 sync build/ s3://${{ secrets.S3_WEBPAGE_BUCKET_NAME }} --delete

      - name: CloudFront ìºì‹œ ë¬´íš¨í™” (Invalidation)
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_ID }} --paths "/*"
