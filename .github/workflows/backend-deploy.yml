# .github/workflows/backend-deploy.disabled.yml (Backend)
name: Backend CI/CD

on:
  push:
    branches: [ "main" ]
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - '!backend/README.md'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_IMAGE_BACKEND }} # 5ë‹¨ê³„ì—ì„œ ë“±ë¡í•œ Secret ì‚¬ìš©

        # [ìë™í™”] í´ë”ê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë‚˜ë‹ˆê¹Œ, ë¯¸ë¦¬ ìƒì„±í•´ì¤ë‹ˆë‹¤!
      - name: Create directory on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
              # -p ì˜µì…˜: í´ë”ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ë¬´ì‹œí•˜ê³ , ì—†ìœ¼ë©´ ë§Œë“­ë‹ˆë‹¤. (ì—ëŸ¬ ì•ˆ ë‚¨!)
              mkdir -p /home/ubuntu/timedeal-platform
            # [ìƒˆë¡œ ì¶”ê°€] docker-compose.yml íŒŒì¼ì„ EC2ë¡œ ì „ì†¡(ë³µì‚¬)í•˜ëŠ” ë‹¨ê³„
      # ğŸ‘‡ [ìˆ˜ì •ë¨] nginx.confë„ ê°™ì´ ë³µì‚¬í•˜ë„ë¡ ì¶”ê°€!
      - name: Copy Docker Compose file to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          # ë‚´ ê¹ƒí—ˆë¸Œì— ìˆëŠ” íŒŒì¼ì„ -> EC2 í´ë”ë¡œ ë³µì‚¬í•´ë¼!
          source: "docker-compose.yml,nginx.conf"
          target: "/home/ubuntu/timedeal-platform"
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        env:
          FRONTEND_URL: ${{ vars.FRONTEND_URL }}
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          TOSS_PAYMENTS_SECRET_KEY: ${{ secrets.TOSS_PAYMENTS_SECRET_KEY }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKER_IMAGE_BACKEND }}
          DOCKER_IMAGE_FRONTEND: ${{ secrets.DOCKER_IMAGE_FRONTEND }}
          REACT_APP_NAVER_MAPS_CLIENT_ID: ${{ secrets.REACT_APP_NAVER_MAPS_CLIENT_ID }}
          REACT_APP_NAVER_MAPS_SECRET: ${{ secrets.REACT_APP_NAVER_MAPS_SECRET }}
          GONGGONG_KEY: ${{ secrets.GONGGONG_KEY }}
          COOKIE_SECURE: ${{ secrets.COOKIE_SECURE }}
          GOOGLE_REDIRECT_URI: ${{ vars.GOOGLE_REDIRECT_URI }}
          NAVER_REDIRECT_URI: ${{ vars.NAVER_REDIRECT_URI }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          REACT_APP_SGIS_CLIENT_KEY: ${{ secrets.REACT_APP_SGIS_CLIENT_KEY }}
          REACT_APP_SGIS_SECRET: ${{ secrets.REACT_APP_SGIS_SECRET }}

        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          # âš ï¸ [í•µì‹¬] GitHub Secretsì˜ ê°’ì„ ë³€ìˆ˜ë¡œ ë„˜ê¹ë‹ˆë‹¤.
          # (ì´ë ‡ê²Œ í•´ì•¼ ë¹„ë°€ë²ˆí˜¸ì— íŠ¹ìˆ˜ë¬¸ìê°€ ìˆì–´ë„ ì—ëŸ¬ê°€ ì•ˆ ë‚©ë‹ˆë‹¤)
          envs: >
            DB_URL,
            DB_USERNAME,
            DB_PASSWORD,
            FRONTEND_URL,
            COOKIE_SECURE,
            JWT_SECRET,
            GOOGLE_CLIENT_ID,
            GOOGLE_CLIENT_SECRET,
            NAVER_CLIENT_ID,
            NAVER_CLIENT_SECRET,
            TOSS_PAYMENTS_SECRET_KEY,
            AWS_ACCESS_KEY,
            AWS_SECRET_KEY,
            S3_BUCKET_NAME,
            DOCKER_IMAGE_BACKEND,
            DOCKER_IMAGE_FRONTEND,
            REACT_APP_NAVER_MAPS_CLIENT_ID,
            REACT_APP_NAVER_MAPS_SECRET,
            GONGGONG_KEY,
            GOOGLE_REDIRECT_URI,
            NAVER_REDIRECT_URI,
            DOCKERHUB_USERNAME,
            DOCKERHUB_TOKEN,
            REACT_APP_SGIS_CLIENT_KEY,
            REACT_APP_SGIS_SECRET


          script: |
            # ë¡œê·¸ì¸ ëª…ë ¹ì–´ ì¶”ê°€ (ë§¨ ìœ—ì¤„ì—!)
            echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            cd /home/ubuntu/timedeal-platform

            # 2. ê¸°ì¡´ .env ì‚­ì œ í›„ ìƒˆë¡œ ìƒì„± (ì´ˆê¸°í™”)
            rm -f .env
            touch .env

            # 3. í™˜ê²½ ë³€ìˆ˜ ì£¼ì… (ìœ„ì˜ envsì—ì„œ ë°›ì•„ì˜¨ ê°’ë“¤ì„ íŒŒì¼ì— ì”€)
            echo "DB_URL=$DB_URL" >> .env
            echo "DB_USERNAME=$DB_USERNAME" >> .env
            echo "DB_PASSWORD=$DB_PASSWORD" >> .env

            echo "FRONTEND_URL=$FRONTEND_URL" >> .env
            echo "COOKIE_SECURE=$COOKIE_SECURE" >> .env
            echo "JWT_SECRET=$JWT_SECRET" >> .env

            echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env
            echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env
            echo "NAVER_CLIENT_ID=$NAVER_CLIENT_ID" >> .env
            echo "NAVER_CLIENT_SECRET=$NAVER_CLIENT_SECRET" >> .env

            echo "TOSS_PAYMENTS_SECRET_KEY=$TOSS_PAYMENTS_SECRET_KEY" >> .env
            echo "AWS_ACCESS_KEY=$AWS_ACCESS_KEY" >> .env
            echo "AWS_SECRET_KEY=$AWS_SECRET_KEY" >> .env
            echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> .env

            echo "DOCKER_IMAGE_BACKEND=$DOCKER_IMAGE_BACKEND" >> .env
            echo "DOCKER_IMAGE_FRONTEND=$DOCKER_IMAGE_FRONTEND" >> .env

            echo "REACT_APP_NAVER_MAPS_CLIENT_ID=$REACT_APP_NAVER_MAPS_CLIENT_ID" >> .env
            echo "REACT_APP_NAVER_MAPS_SECRET=$REACT_APP_NAVER_MAPS_SECRET" >> .env
            echo "GONGGONG_KEY=$GONGGONG_KEY" >> .env
            echo "GOOGLE_REDIRECT_URI=$GOOGLE_REDIRECT_URI" >> .env
            echo "NAVER_REDIRECT_URI=$NAVER_REDIRECT_URI" >> .env
            echo "REACT_APP_SGIS_CLIENT_KEY=$REACT_APP_SGIS_CLIENT_KEY" >> .env
            echo "REACT_APP_SGIS_SECRET=$REACT_APP_SGIS_SECRET" >> .env

            # 4. íŒŒì¼ ì˜ ë§Œë“¤ì–´ì¡Œë‚˜ í™•ì¸ (ë‚´ìš©ì€ ë³´ì•ˆìƒ ì•ˆ ë³´ì—¬ì£¼ê³  íŒŒì¼ ìœ ë¬´ë§Œ ì²´í¬)
            echo "Making .env file... Done!"
            ls -al .env

            # 2. ìµœì‹  ë°±ì—”ë“œ ì´ë¯¸ì§€ë¥¼ pull
            docker-compose pull backend

            # 3. ë°±ì—”ë“œë‘ ì—”ì§„ì—‘ìŠ¤ ë‘˜ ë‹¤ ì¬ì‹œì‘ (ì—…ë°ì´íŠ¸ ë°˜ì˜)
            docker-compose up -d --no-deps backend nginx

            # 6. ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
